<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>관리자 페이지</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="/main.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="/app.js"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>
</head>
<body>
   <!-- 관리자 -->
    <div id="main-content" class="container">
        <div class="row">
            <h2>관리자 페이지</h2>

            <h3>방송관리(시작, 종료)</h3>
            <div id="broadcast">

            </div>
            
            
            
        </div>
        
        <div class="row">
            <!-- 경매 컨트롤 시작 종료 선택 -->
            <h3>관리자 방송화면(경매 관리)</h3>
            <div id="broadcastInfo"></div>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>경매 리스트</th>
                    <th>경매 물품</th>
                    <th>시작가</th>
                    <th>최고가</th>
                    <th>최고 입찰자</th>
                    <th>현재 입찰가</th>
                    <th>버튼</th>
                </tr>
                </thead>
                <tbody id="auctions">
                </tbody>
            </table>

        </div>
    </div>

    <script>
        window.onload = function(){
        const broadcastlist = document.querySelector("#broadcast");
        fetch("http://localhost:8080/temp/broadcasts")
            .then((response) => response.json())
            .then((data)=> {
                data.forEach(element => {
                    const broadcast = document.createElement('div');
                    const info = document.createTextNode(element.id + '. ' +element.title+" \n");
                    const start_btn = document.createElement('button')
                    start_btn.className='btn btn-default'
                    start_btn.innerText = "방송 시작 \n"
                    start_btn.type = "submit"
                    start_btn.id = "start" + element.id
                    start_btn.setAttribute("onclick", "start(this.id)")
                    if(element.status) start_btn.disabled = "disabled"
                    const end_btn = document.createElement('button')
                    end_btn.className='btn btn-default'
                    end_btn.innerText = "방송 종료"
                    end_btn.type = "submit"
                    if(!element.status) end_btn.disabled = "disabled"
                    end_btn.id="end" + element.id
                    end_btn.setAttribute("onclick", "end(this.id)")
                    broadcast.appendChild(info)
                    broadcast.appendChild(start_btn)
                    broadcast.appendChild(end_btn)
                    broadcastlist.appendChild(broadcast);
                });
            })
        }

        function start(broadcastId) {
            const id = broadcastId.slice(-1);

            const broadcastInfo =  document.querySelector("#broadcastInfo");
            broadcastInfo.innerText = "방송 번호: "+ id + "번";

            const start = document.querySelector("#"+broadcastId)
            start.setAttribute("disabled", "disabled")

            const end = document.querySelector("#end"+id);
            end.removeAttribute("disabled")

            
            const auctions = document.querySelector("#auctions")
            while(auctions.hasChildNodes()) auctions.removeChild(auctions.firstChild)

            fetch("http://localhost:8080/temp/auctions/"+id)
                .then((response) => response.json()).then((data)=> {
                    data.forEach(element => {
                        console.log(element)
                        const auction = document.createElement('tr')
                        const index = document.createElement('td')
                        index.innerText = element.id
                        const title = document.createElement('td')
                        title.innerText = element.title
                        const start_price = document.createElement('td')
                        start_price.innerText = element.start_price
                        const bid_useremail = document.createElement('td')
                        const highest_price = document.createElement('td')
                        const current_price = document.createElement('td') //dto 변수 추가 후 내용삽입
                        const button = document.createElement('td')
                        const start_btn = document.createElement('button')
                        start_btn.className='btn btn-default'
                        start_btn.innerText = "경매 시작 \n"
                        start_btn.type = "submit"
                        start_btn.id = "begin" + element.id
                        start_btn.setAttribute("onclick", "begin(this.id)")
                        const end_btn = document.createElement('button')
                        end_btn.className='btn btn-default'
                        end_btn.innerText = "경매 종료"
                        end_btn.type = "submit"
                        end_btn.disabled = "disabled"
                        end_btn.id="end" + element.id
                        end_btn.setAttribute("onclick", "stop(this.id)")
                        button.appendChild(start_btn);
                        button.appendChild(end_btn)

                        auction.appendChild(index)
                        auction.appendChild(title)
                        auction.appendChild(start_price)
                        auction.appendChild(bid_useremail)
                        auction.appendChild(highest_price)
                        auction.appendChild(current_price)
                        auction.appendChild(button)
                        auctions.appendChild(auction)
                    });
            })
        }

  function end(broadcastId) {
    //방송종료시
    //관리자페이지: 시작버튼 활성화 / 종료버튼 비활성화  
    //서버: 방송status -> false 
    console.log(broadcastId)
    const id = broadcastId.slice(-1);
    //관리자 방송시작 disable 풀고 종료버튼 disable
    const start = document.querySelector("#start"+id)
    start.removeAttribute("disabled")
    
    const end = document.querySelector("#"+broadcastId);
    end.setAttribute("disabled", "disabled")

    //유저 방송
    const part = document.querySelector("#part"+id)
    part.setAttribute("disabled", "disabled")
  }
  function begin(auctionId) {
    //시작버튼 비활성 , 종료버튼 활성

    //유저화면에 경매목록
  }
    </script>
</body>
</html>